name: deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ALIYUN_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ALIYUN_NAMESPACE: wzh-devin
  IMAGE_NAME: dezhi-server

jobs:
  # ==================== æ£€æŸ¥æ ‡ç­¾ ====================
  check-tag:
    runs-on: ubuntu-22.04
    outputs:
      has_tag: ${{ steps.check.outputs.has_tag }}
      version: ${{ steps.check.outputs.version }}

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ ‡ç­¾

      - name: ğŸ·ï¸ Check if commit has tag
        id: check
        run: |
          # è·å–å½“å‰æäº¤çš„æ‰€æœ‰æ ‡ç­¾
          TAGS=$(git tag --points-at HEAD)
          
          echo "=========================================="
          echo "ğŸ” æ£€æŸ¥ main åˆ†æ”¯æ ‡ç­¾"
          echo "=========================================="
          echo "ğŸ“ å½“å‰æäº¤: ${{ github.sha }}"
          echo "ğŸŒ¿ å½“å‰åˆ†æ”¯: ${{ github.ref }}"
          echo ""
          
          if [ -z "$TAGS" ]; then
            echo "âŒ é”™è¯¯: main åˆ†æ”¯æäº¤å¿…é¡»æ‰“æ ‡ç­¾æ‰èƒ½è§¦å‘éƒ¨ç½²ï¼"
            echo ""
            echo "ğŸ’¡ è¯·å…ˆæ‰“æ ‡ç­¾åå†æ¨é€ï¼š"
            echo "   git tag v1.0.0"
            echo "   git push origin main --tags"
            echo ""
            echo "=========================================="
            exit 1
          else
            # è·å–ç¬¬ä¸€ä¸ª v*.*.* æ ¼å¼çš„æ ‡ç­¾
            VERSION_TAG=$(echo "$TAGS" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
          
            if [ -z "$VERSION_TAG" ]; then
              echo "âŒ é”™è¯¯: æœªæ‰¾åˆ°ç¬¦åˆ v*.*.* æ ¼å¼çš„æ ‡ç­¾ï¼"
              echo ""
              echo "ğŸ“‹ å½“å‰æ ‡ç­¾: $TAGS"
              echo "âœ… éœ€è¦æ ¼å¼: v1.0.0, v2.1.3 ç­‰"
              echo ""
              echo "=========================================="
              exit 1
            fi
          
            echo "âœ… æ‰¾åˆ°ç‰ˆæœ¬æ ‡ç­¾: $VERSION_TAG"
            echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: latest, $VERSION_TAG"
            echo "=========================================="
            echo "has_tag=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION_TAG" >> $GITHUB_OUTPUT
          fi

  build-and-deploy:
    runs-on: ubuntu-22.04
    needs: [check-tag]
    if: needs.check-tag.outputs.has_tag == 'true'

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v3

      - name: ğŸ“ Show version info
        run: |
          echo "=========================================="
          echo "ğŸ·ï¸  ç‰ˆæœ¬å‘å¸ƒ"
          echo "=========================================="
          echo "ğŸ“¦ ç‰ˆæœ¬å·: ${{ needs.check-tag.outputs.version }}"
          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: latest, ${{ needs.check-tag.outputs.version }}"
          echo "=========================================="

      # ==================== Maven æ„å»º ====================
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ”¨ Build with Maven
        run: |
          echo "=========================================="
          echo "ğŸ”¨ å¼€å§‹ Maven æ„å»º"
          echo "=========================================="
          mvn clean package -DskipTests -B
          
          echo ""
          echo "ğŸ“¦ æ£€æŸ¥ç”Ÿæˆçš„ JAR æ–‡ä»¶:"
          ls -lh dezhi-core/target/*.jar
          
          if [ ! -f dezhi-core/target/dezhi-core-1.0-SNAPSHOT.jar ]; then
            echo "âŒ JAR æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          echo "âœ… Maven æ„å»ºå®Œæˆ"
          echo "=========================================="

      # ==================== Docker æ„å»º ====================
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ğŸ”‘ Login to Aliyun Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      # ==================== æ„å»ºå¹¶æ¨é€é•œåƒ ====================
      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ needs.check-tag.outputs.version }}
          labels: |
            org.opencontainers.image.version=${{ needs.check-tag.outputs.version }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ“¦ Image Build Summary
        run: |
          echo "=========================================="
          echo "âœ… Docker é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo "=========================================="
          echo "ğŸ“¦ ç‰ˆæœ¬: ${{ needs.check-tag.outputs.version }}"
          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: latest, ${{ needs.check-tag.outputs.version }}"
          echo ""
          echo "ğŸ”— å®Œæ•´é•œåƒåœ°å€:"
          echo "   - ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          echo "   - ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ needs.check-tag.outputs.version }}"
          echo "=========================================="

      # ==================== ä¸Šä¼ é…ç½®æ–‡ä»¶ ====================
      - name: ğŸ“¤ Upload docker-compose.yaml to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "docs/docker/docker-compose.yaml"
          target: "/tmp/deploy/"
          strip_components: 2

      # ==================== éƒ¨ç½²åˆ°æœåŠ¡å™¨ ====================
      - name: ğŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 30m
          command_timeout: 30m
          script: |
            set -e
            
            echo "=========================================="
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²ç‰ˆæœ¬: ${{ needs.check-tag.outputs.version }}"
            echo "=========================================="
            
            DEPLOY_DIR="/root/dezhi/server"
            CONTAINER_NAME="dezhi-server"
            VERSION="${{ needs.check-tag.outputs.version }}"
            
            echo "ğŸ“ éƒ¨ç½²ç›®å½•: ${DEPLOY_DIR}"
            echo "ğŸ“¦ å®¹å™¨åç§°: ${CONTAINER_NAME}"
            echo "ğŸ·ï¸  éƒ¨ç½²ç‰ˆæœ¬: ${VERSION}"
            echo ""
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p ${DEPLOY_DIR}
            
            # å¤åˆ¶é…ç½®æ–‡ä»¶
            if [ -f /tmp/deploy/docker-compose.yaml ]; then
              cp /tmp/deploy/docker-compose.yaml ${DEPLOY_DIR}/
              echo "âœ… docker-compose.yaml å·²æ›´æ–°"
            else
              echo "âŒ docker-compose.yaml æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
            
            rm -rf /tmp/deploy
            cd ${DEPLOY_DIR}
            
            # ç™»å½•é˜¿é‡Œäº‘
            echo ""
            echo "ğŸ” ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
            echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login \
              --username="${{ secrets.ALIYUN_REGISTRY_USERNAME }}" \
              --password-stdin \
              ${{ env.ALIYUN_REGISTRY }}
            
            echo "âœ… ç™»å½•æˆåŠŸ"
            
            # è®¾ç½®ç¯å¢ƒå˜é‡
            export ALIYUN_REGISTRY="${{ env.ALIYUN_REGISTRY }}"
            export ALIYUN_NAMESPACE="${{ env.ALIYUN_NAMESPACE }}"
            export IMAGE_NAME="${{ env.IMAGE_NAME }}"
            export CONTAINER_NAME="${CONTAINER_NAME}"
            export IMAGE_TAG="${VERSION}"
            
            echo ""
            echo "ğŸ“¦ ä½¿ç”¨é•œåƒ: ${ALIYUN_REGISTRY}/${ALIYUN_NAMESPACE}/${IMAGE_NAME}:${IMAGE_TAG}"