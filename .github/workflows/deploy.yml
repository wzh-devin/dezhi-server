name: deploy

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  ALIYUN_REGISTRY: registry.cn-hangzhou.aliyuncs.com
  ALIYUN_NAMESPACE: wzh-devin
  IMAGE_NAME: dezhi-server

jobs:
  build-and-deploy:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # ==================== æ£€æŸ¥å¹¶æå–ç‰ˆæœ¬å· ====================
      - name: ğŸ“ Check tag and extract version
        id: version
        run: |
          # è·å–å½“å‰æäº¤çš„æ‰€æœ‰æ ‡ç­¾
          TAGS=$(git tag --points-at HEAD)
          
          echo "=========================================="
          echo "ğŸ” æ£€æŸ¥ç‰ˆæœ¬æ ‡ç­¾"
          echo "=========================================="
          echo "ğŸ“ å½“å‰æäº¤: ${{ github.sha }}"
          echo "ğŸŒ¿ å½“å‰åˆ†æ”¯: ${{ github.ref }}"
          echo ""
          
          if [ -z "$TAGS" ]; then
            echo "âš ï¸  å½“å‰æäº¤æ²¡æœ‰æ ‡ç­¾"
            echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: latest"
            echo "=========================================="
            echo "has_tag=false" >> $GITHUB_OUTPUT
            echo "version=latest" >> $GITHUB_OUTPUT
            echo "image_tags=latest" >> $GITHUB_OUTPUT
          else
            # è·å–ç¬¬ä¸€ä¸ª v*.*.* æ ¼å¼çš„æ ‡ç­¾
            VERSION_TAG=$(echo "$TAGS" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
          
            if [ -z "$VERSION_TAG" ]; then
              echo "âš ï¸  å½“å‰æ ‡ç­¾ä¸ç¬¦åˆ v*.*.* æ ¼å¼"
              echo "ğŸ“‹ å½“å‰æ ‡ç­¾: $TAGS"
              echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: latest"
              echo "=========================================="
              echo "has_tag=false" >> $GITHUB_OUTPUT
              echo "version=latest" >> $GITHUB_OUTPUT
              echo "image_tags=latest" >> $GITHUB_OUTPUT
            else
              echo "âœ… æ‰¾åˆ°ç‰ˆæœ¬æ ‡ç­¾: $VERSION_TAG"
              echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: latest, $VERSION_TAG"
              echo "=========================================="
              echo "has_tag=true" >> $GITHUB_OUTPUT
              echo "version=$VERSION_TAG" >> $GITHUB_OUTPUT
              echo "image_tags=latest,$VERSION_TAG" >> $GITHUB_OUTPUT
            fi
          fi

      # ==================== Maven æ„å»º ====================
      - name: â˜• Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ”¨ Build with Maven
        run: |
          echo "=========================================="
          echo "ğŸ”¨ å¼€å§‹ Maven æ„å»º"
          echo "=========================================="
          mvn clean package -DskipTests -B
          
          echo ""
          echo "ğŸ“¦ æ£€æŸ¥ç”Ÿæˆçš„ JAR æ–‡ä»¶:"
          ls -lh dezhi-core/target/*.jar
          
          if [ ! -f dezhi-core/target/dezhi-core-1.0-SNAPSHOT.jar ]; then
            echo "âŒ JAR æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            exit 1
          fi
          
          echo "âœ… Maven æ„å»ºå®Œæˆ"
          echo "=========================================="

      # ==================== Docker æ„å»º ====================
      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: ğŸ”‘ Login to Aliyun Container Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      # ==================== æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆæœ‰æ ‡ç­¾ç‰ˆæœ¬ï¼‰====================
      - name: ğŸ—ï¸ Build and push Docker image (with version tag)
        if: steps.version.outputs.has_tag == 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
          labels: |
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # ==================== æ„å»ºå¹¶æ¨é€é•œåƒï¼ˆä»… latestï¼‰====================
      - name: ğŸ—ï¸ Build and push Docker image (latest only)
        if: steps.version.outputs.has_tag == 'false'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest
          labels: |
            org.opencontainers.image.version=latest
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ“¦ Image Build Summary
        run: |
          echo "=========================================="
          echo "âœ… Docker é•œåƒæ„å»ºå¹¶æ¨é€æˆåŠŸï¼"
          echo "=========================================="
          
          if [ "${{ steps.version.outputs.has_tag }}" == "true" ]; then
            echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
            echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: latest, ${{ steps.version.outputs.version }}"
            echo ""
            echo "ğŸ”— å®Œæ•´é•œåƒåœ°å€:"
            echo "   - ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
            echo "   - ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
          else
            echo "ğŸ“¦ ç‰ˆæœ¬: latest (å¼€å‘ç‰ˆæœ¬)"
            echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: latest"
            echo ""
            echo "ğŸ”— å®Œæ•´é•œåƒåœ°å€:"
            echo "   - ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}:latest"
          fi
          
          echo "=========================================="

      # ==================== ä¸Šä¼ é…ç½®æ–‡ä»¶ ====================
      - name: ğŸ“¤ Upload docker-compose.yaml to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          source: "docs/docker/docker-compose.yaml"
          target: "/tmp/deploy/"
          strip_components: 2

      # ==================== éƒ¨ç½²åˆ°æœåŠ¡å™¨ ====================
      - name: ğŸš€ Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          timeout: 30m
          command_timeout: 30m
          script: |
            set -e
            
            echo "=========================================="
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
            echo "=========================================="
            
            DEPLOY_DIR="/root/dezhi/server"
            CONTAINER_NAME="dezhi-server"
            VERSION="${{ steps.version.outputs.version }}"
            HAS_TAG="${{ steps.version.outputs.has_tag }}"
            
            echo "ğŸ“ éƒ¨ç½²ç›®å½•: ${DEPLOY_DIR}"
            echo "ğŸ“¦ å®¹å™¨åç§°: ${CONTAINER_NAME}"
            echo "ğŸ·ï¸  éƒ¨ç½²ç‰ˆæœ¬: ${VERSION}"
            
            if [ "$HAS_TAG" == "true" ]; then
              echo "ğŸ“Œ éƒ¨ç½²ç±»å‹: æ­£å¼ç‰ˆæœ¬å‘å¸ƒ"
            else
              echo "ğŸ“Œ éƒ¨ç½²ç±»å‹: å¼€å‘ç‰ˆæœ¬æ›´æ–°"
            fi
            echo ""
            
            # åˆ›å»ºéƒ¨ç½²ç›®å½•
            mkdir -p ${DEPLOY_DIR}
            
            # å¤åˆ¶é…ç½®æ–‡ä»¶
            if [ -f /tmp/deploy/docker-compose.yaml ]; then
              cp /tmp/deploy/docker-compose.yaml ${DEPLOY_DIR}/
              echo "âœ… docker-compose.yaml å·²æ›´æ–°"
            else
              echo "âŒ docker-compose.yaml æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
            
            rm -rf /tmp/deploy
            cd ${DEPLOY_DIR}
            
            # ç™»å½•é˜¿é‡Œäº‘
            echo ""
            echo "ğŸ” ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡..."
            echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login \
              --username="${{ secrets.ALIYUN_REGISTRY_USERNAME }}" \
              --password-stdin \
              ${{ env.ALIYUN_REGISTRY }}
            
            echo "âœ… ç™»å½•æˆåŠŸ"
            
            # è®¾ç½®ç¯å¢ƒå˜é‡
            export ALIYUN_REGISTRY="${{ env.ALIYUN_REGISTRY }}"
            export ALIYUN_NAMESPACE="${{ env.ALIYUN_NAMESPACE }}"
            export IMAGE_NAME="${{ env.IMAGE_NAME }}"
            export CONTAINER_NAME="${CONTAINER_NAME}"
            
            # æ ¹æ®æ˜¯å¦æœ‰æ ‡ç­¾è®¾ç½®ä¸åŒçš„é•œåƒç‰ˆæœ¬
            if [ "$HAS_TAG" == "true" ]; then
              export IMAGE_TAG="${VERSION}"
              echo ""
              echo "ğŸ“¦ ä½¿ç”¨é•œåƒ: ${ALIYUN_REGISTRY}/${ALIYUN_NAMESPACE}/${IMAGE_NAME}:${IMAGE_TAG}"
            else
              export IMAGE_TAG="latest"
              echo ""
              echo "ğŸ“¦ ä½¿ç”¨é•œåƒ: ${ALIYUN_REGISTRY}/${ALIYUN_NAMESPACE}/${IMAGE_NAME}:latest"
            fi
            
            # æ‹‰å–é•œåƒ
            echo ""
            echo "â¬‡ï¸ æ‹‰å–é•œåƒ..."
            docker-compose pull dezhi-server
            echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ"
            
            # åœæ­¢æ—§å®¹å™¨
            echo ""
            echo "ğŸ”„ åœæ­¢æ—§å®¹å™¨..."
            docker-compose stop dezhi-server 2>/dev/null || true
            docker-compose rm -f dezhi-server 2>/dev/null || true
            echo "âœ… æ—§å®¹å™¨å·²åœæ­¢"
            
            # å¯åŠ¨æ–°å®¹å™¨
            echo ""
            echo "ğŸš€ å¯åŠ¨æ–°å®¹å™¨..."
            docker-compose up -d dezhi-server
            echo "âœ… å®¹å™¨å·²å¯åŠ¨"
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo ""
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆ30ç§’ï¼‰..."
            sleep 30
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            echo ""
            echo "ğŸ“Š å®¹å™¨çŠ¶æ€:"
            docker-compose ps dezhi-server
            
            echo ""
            echo "ğŸ“ æœ€è¿‘æ—¥å¿—:"
            docker-compose logs --tail=50 dezhi-server
            
            # å¥åº·æ£€æŸ¥
            echo ""
            if docker-compose ps dezhi-server | grep -q "Up"; then
              echo "âœ… å®¹å™¨è¿è¡Œæ­£å¸¸"
            else
              echo "âŒ å®¹å™¨æœªæ­£å¸¸è¿è¡Œ"
              echo ""
              echo "å®Œæ•´æ—¥å¿—:"
              docker-compose logs dezhi-server
              exit 1
            fi
            
            # æ¸…ç†æ—§é•œåƒï¼ˆåªåœ¨æ­£å¼ç‰ˆæœ¬å‘å¸ƒæ—¶æ¸…ç†ï¼‰
            if [ "$HAS_TAG" == "true" ]; then
              echo ""
              echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€è¿‘5ä¸ªç‰ˆæœ¬ï¼‰..."
              OLD_IMAGES=$(docker images "${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.IMAGE_NAME }}" --format "{{.ID}}" | tail -n +6)
              if [ -n "$OLD_IMAGES" ]; then
                echo "$OLD_IMAGES" | xargs -r docker rmi 2>/dev/null || true
                echo "âœ… å·²æ¸…ç†æ—§é•œåƒ"
              else
                echo "â„¹ï¸  æ— éœ€æ¸…ç†"
              fi
            fi
            
            docker logout ${{ env.ALIYUN_REGISTRY }} 2>/dev/null || true
            
            echo ""
            echo "=========================================="
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "=========================================="
            echo "ğŸ“¦ éƒ¨ç½²ç‰ˆæœ¬: ${VERSION}"
            
            if [ "$HAS_TAG" == "true" ]; then
              echo "ğŸ“Œ éƒ¨ç½²ç±»å‹: æ­£å¼ç‰ˆæœ¬"
            else
              echo "ğŸ“Œ éƒ¨ç½²ç±»å‹: å¼€å‘ç‰ˆæœ¬"
            fi
            
            echo "â° å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

      # ==================== éƒ¨ç½²æ€»ç»“ ====================
      - name: âœ… Deployment Summary
        if: success()
        run: |
          echo "=========================================="
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "=========================================="
          echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "ğŸ·ï¸  é•œåƒæ ‡ç­¾: ${{ steps.version.outputs.image_tags }}"
          echo "ğŸ–¥ï¸  æœåŠ¡å™¨: ${{ secrets.SERVER_HOST }}"
          
          if [ "${{ steps.version.outputs.has_tag }}" == "true" ]; then
            echo "ğŸ“Œ éƒ¨ç½²ç±»å‹: æ­£å¼ç‰ˆæœ¬å‘å¸ƒ"
          else
            echo "ğŸ“Œ éƒ¨ç½²ç±»å‹: å¼€å‘ç‰ˆæœ¬æ›´æ–°"
          fi
          
          echo "â° æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "=========================================="

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "=========================================="
          echo "ğŸ’¥ éƒ¨ç½²å¤±è´¥ï¼"
          echo "=========================================="
          echo "ğŸ“¦ ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
          echo "è¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯æ—¥å¿—"
          echo "=========================================="