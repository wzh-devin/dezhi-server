# .github/workflows/test-ssh-password.yml
name: Test SSH with Password

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ” æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        run: |
          echo "=========================================="
          echo "ä½¿ç”¨å¯†ç æµ‹è¯• SSH è¿æ¥"
          echo "=========================================="
          echo "æœåŠ¡å™¨åœ°å€: ${{ secrets.SERVER_HOST }}"
          echo "ç”¨æˆ·å: ${{ secrets.SERVER_USERNAME }}"
          echo "=========================================="

      - name: ğŸ” æµ‹è¯• SSH è¿æ¥ï¼ˆå¯†ç æ–¹å¼ï¼‰
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}  # ä½¿ç”¨å¯†ç 
          port: 22
          timeout: 30s
          debug: true
          script: |
            echo "=========================================="
            echo "âœ… SSH è¿æ¥æˆåŠŸï¼"
            echo "=========================================="
            echo "ä¸»æœºå: $(hostname)"
            echo "å½“å‰ç”¨æˆ·: $(whoami)"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "ç³»ç»Ÿä¿¡æ¯: $(uname -a)"
            echo ""
            echo "ç£ç›˜ä½¿ç”¨:"
            df -h | head -5
            echo ""
            echo "å†…å­˜ä½¿ç”¨:"
            free -h
            echo "=========================================="

      - name: ğŸ“ æ£€æŸ¥éƒ¨ç½²ç›®å½•
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            echo "æ£€æŸ¥éƒ¨ç½²ç›®å½•..."
            
            if [ -d "/root/dezhi/server" ]; then
              echo "âœ… ç›®å½•å­˜åœ¨: /root/dezhi/server"
              ls -la /root/dezhi/server
            else
              echo "âš ï¸ ç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç›®å½•..."
              mkdir -p /root/dezhi/server
              echo "âœ… ç›®å½•å·²åˆ›å»º"
            fi

      - name: ğŸ³ æ£€æŸ¥ Docker
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            echo "æ£€æŸ¥ Docker..."
            if command -v docker &> /dev/null; then
              echo "âœ… Docker å·²å®‰è£…: $(docker --version)"
            else
              echo "âŒ Docker æœªå®‰è£…"
            fi
            
            echo ""
            echo "æ£€æŸ¥ Docker Compose..."
            if command -v docker-compose &> /dev/null; then
              echo "âœ… Docker Compose å·²å®‰è£…: $(docker-compose --version)"
            else
              echo "âŒ Docker Compose æœªå®‰è£…"
            fi

      - name: âœ… æµ‹è¯•æˆåŠŸ
        if: success()
        run: |
          echo "=========================================="
          echo "ğŸ‰ SSH å¯†ç è¿æ¥æµ‹è¯•é€šè¿‡ï¼"
          echo "=========================================="